name: Flask Agri Front CI/CD

on: 
  push:
    branches: 
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pages: write
      id-token: write

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Clean install
      run: |
        cd flask_agri_front
        rm -rf node_modules
        rm -f package-lock.json
        npm install --legacy-peer-deps
        
    - name: Create Cesium configuration
      run: |
        cd flask_agri_front
        # 创建 Cesium 配置文件
        mkdir -p src/utils
        cat > src/utils/cesiumConfig.js << 'EOF'
        // Cesium 配置
        import * as Cesium from 'cesium';
        
        // 设置静态资源路径
        window.CESIUM_BASE_URL = '/skyvisions/cesium/';
        
        // 导出 Cesium 供其他模块使用
        export default Cesium;
        
        console.log('Cesium configured with base URL:', window.CESIUM_BASE_URL);
        EOF
        
    - name: Update main entry file
      run: |
        cd flask_agri_front
        # 在主入口文件中引入 Cesium 配置
        if [ -f "src/main.js" ]; then
          # 在 main.js 顶部添加引入
          sed -i '1iimport "./utils/cesiumConfig";' src/main.js
        elif [ -f "src/main.ts" ]; then
          sed -i '1iimport "./utils/cesiumConfig";' src/main.ts
        fi
        
    - name: Build project
      run: |
        cd flask_agri_front
        npm run build || npx vite build --mode production
        
    - name: Copy Cesium assets
      run: |
        cd flask_agri_front
        echo "复制 Cesium 资源文件..."
        
        # 创建目标目录
        mkdir -p dist/cesium
        
        # 检查 node_modules 中的 Cesium
        echo "检查 node_modules/cesium 目录:"
        ls -la node_modules/cesium/Build/ || echo "Cesium 目录不存在"
        
        # 复制 Cesium 核心文件
        cp -r node_modules/cesium/Build/Cesium/* dist/cesium/ || echo "复制失败，可能路径不对"
        
        # 验证复制结果
        echo "复制后的 cesium 目录:"
        ls -la dist/cesium/ || echo "cesium 目录不存在"
        
    - name: Setup Pages
      uses: actions/configure-pages@v4
        
    - name: Upload artifact to GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: flask_agri_front/dist/

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4